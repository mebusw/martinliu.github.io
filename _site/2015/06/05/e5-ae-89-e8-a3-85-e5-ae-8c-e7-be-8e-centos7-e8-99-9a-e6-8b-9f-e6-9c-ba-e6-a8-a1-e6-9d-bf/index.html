<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>安装完美 CentOS7 虚拟机模板 &#8211; Martin's Blog</title>
<meta name="description" content="CentOS7是最近似于 RHEL7的企业板Linux好处是不用多说的。在它上面做一些开原软件的测试是非常方便和稳定的。我可能会用它做后续的一些系列文档，先打个基础。希望它也能广泛地用于其它的KVM，OVirt和OpenStack的场景中。">
<meta name="keywords" content="centos, linux, RHEL">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/">
<meta name="twitter:title" content="安装完美 CentOS7 虚拟机模板">
<meta name="twitter:description" content="CentOS7是最近似于 RHEL7的企业板Linux好处是不用多说的。在它上面做一些开原软件的测试是非常方便和稳定的。我可能会用它做后续的一些系列文档，先打个基础。希望它也能广泛地用于其它的KVM，OVirt和OpenStack的场景中。">
<meta name="twitter:creator" content="@zliu">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="安装完美 CentOS7 虚拟机模板">
<meta property="og:description" content="CentOS7是最近似于 RHEL7的企业板Linux好处是不用多说的。在它上面做一些开原软件的测试是非常方便和稳定的。我可能会用它做后续的一些系列文档，先打个基础。希望它也能广泛地用于其它的KVM，OVirt和OpenStack的场景中。">
<meta property="og:url" content="/2015/06/05/e5-ae-89-e8-a3-85-e5-ae-8c-e7-be-8e-centos7-e8-99-9a-e6-8b-9f-e6-9c-ba-e6-a8-a1-e6-9d-bf/">
<meta property="og:site_name" content="Martin's Blog">





<link rel="canonical" href="/2015/06/05/e5-ae-89-e8-a3-85-e5-ae-8c-e7-be-8e-centos7-e8-99-9a-e6-8b-9f-e6-9c-ba-e6-a8-a1-e6-9d-bf/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Martin's Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">首页</a></li>
		<li>
			<a href="#">关于</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="Martin Liu photo" class="author-photo">
					<h4>Martin Liu</h4>
					<p>DevOps Coach, Cloud Expert, Runner</p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">详情</span></a></li>
				<li>
					<a href="mailto:67120666@qq.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/zliu"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				<li>
					<a href="https://google.com/+MartinLiu-cn"><i class="fa fa-fw fa-google-plus"></i> Google+</a>
				</li>
				<li>
					<a href="https://linkedin.com/in/liuzheng"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/martinliu"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">文章</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">所有文章</a></li>
				<li><a href="/tags/">所有分类</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="http://www.aws-faq.com" target="_blank">AWS-FAQ</a></li>
	  
	    
	    <li><a href="http://devopscoach.org" target="_blank">DevOps教练</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/2015/06/05/e5-ae-89-e8-a3-85-e5-ae-8c-e7-be-8e-centos7-e8-99-9a-e6-8b-9f-e6-9c-ba-e6-a8-a1-e6-9d-bf/" rel="bookmark" title="安装完美 CentOS7 虚拟机模板">安装完美 CentOS7 虚拟机模板</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2015-06-05T23:44:52+08:00">June 05, 2015</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~2 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <h2 id="section">初始化安装</h2>

<p>下载最新版CentOS7 DVD 选择mini安装。</p>

<h2 id="section-1">网络配置</h2>

<p>安装过程中设置了静态网络地址，如下：</p>

<p>[bash]</p>

<p>[root@centos7-tmp ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0
TYPE=Ethernet
BOOTPROTO=none
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=no
NAME=eth0
DEVICE=eth0
ONBOOT=yes
DNS1=192.168.10.1
DOMAIN=xenlab.com
IPADDR=192.168.10.8
PREFIX=24
GATEWAY=192.168.10.1
UUID=5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03</p>

<p>[/bash]</p>

<h2 id="section-2">软件包</h2>

<p>Change log:</p>

<ol>
  <li>
    <p> yum install wget <a href="http://itgeeker.net/tag/telnet/">telnet</a> perl perl-devel net-tools kernel-devel</p>
  </li>
  <li>
    <p>yum install vim-enhanced.x86_64</p>
  </li>
  <li>
    <p>yum -y install git</p>
  </li>
  <li>
    <p>yum install acpid</p>
  </li>
  <li>
    <p>yum install tree</p>
  </li>
  <li>
    <p>yum install ntp</p>
  </li>
  <li>
    <p>yum install unzip</p>
  </li>
</ol>

<h2 id="repo-">Repo 软件更新源</h2>

<p>Change log:</p>

<ol>
  <li>
    <p>初始化安装，添加了个几个国内的源</p>
  </li>
  <li></li>
</ol>

<p>rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm</p>

<ol>
  <li>
    <p>/etc/yum.repo/bk/dvd.repo ；这个是在用KVM虚拟机挂ISO文件光驱的时候用的，到时候 mount /dev/cdrom /media/dvd , 把该文件方的夫目录中即可使用iso文件中的repos</p>
  </li>
  <li></li>
</ol>

<p>当前的软件源如下：</p>

<p>[bash]</p>

<p>[root@centos7-tmp ~]# yum repolist
Loaded plugins: fastestmirror
Repository base is listed more than once in the configuration
Repository updates is listed more than once in the configuration
Repository extras is listed more than once in the configuration
Repository centosplus is listed more than once in the configuration
Loading mirror speeds from cached hostfile
* base: mirrors.163.com
* epel: mirrors.neusoft.edu.cn
* extras: mirrors.btte.net
* remi-safe: remi.kazukioishi.net
* updates: mirrors.btte.net
repo id                                 repo name                                                                          status
base/7/x86_64                           CentOS-7 - Base                                                                    8,652
epel/x86_64                             Extra Packages for Enterprise Linux 7 - x86_64                                     8,022
extras/7/x86_64                         CentOS-7 - Extras                                                                    128
remi-safe                               Safe Remi’s RPM repository for Enterprise Linux 7 - x86_64                           123
updates/7/x86_64                        CentOS-7 - Updates                                                                   609
repolist: 17,534
[root@centos7-tmp ~]#</p>

<p>[/bash]</p>

<h2 id="section-3">系统服务配置</h2>

<p>Change log:</p>

<ol>
  <li>
    <p>关闭SELinux</p>
  </li>
  <li>
    <p>关闭 NetworkManager</p>
  </li>
  <li>
    <p>关闭 FirewallD</p>
  </li>
  <li>
    <p>systemctl enable acpid.service</p>
  </li>
  <li>
    <p>开启 truned-adm virtual-guest 服务模式</p>
  </li>
  <li>
    <p>systemctl enable ntpd</p>
  </li>
</ol>

<p>[bash]</p>

<p>[root@centos7-tmp tuned]# tuned-adm  list
Cannot talk to Tuned daemon via DBus.
Available profiles:
- balanced
- desktop
- latency-performance
- network-latency
- network-throughput
- powersave
- throughput-performance
- virtual-guest
- virtual-host
Cannot talk to Tuned daemon via DBus.
It seems that tuned daemon is not running, preset profile is not activated.
Preset profile: virtual-guest</p>

<p>[/bash]</p>

<h2 id="section-4">模板文件封装</h2>

<p>用sys-unconfig 关机。用 virt-sysprep,  virt-sparsify 去除不必要信息，压缩。</p>

<p>[bash]</p>

<p>[root@martin-fedora vm]# ll -h
total 12G
-rw-r–r–  1 qemu qemu  81G Jun  5 22:36 centos7-tmp.qcow2
-rw-r–r–  1 root root  81G Jun  5 22:34 centos7-tmp.qcow2.bk
-rw-r–r–  1 root root 2.9G Jun  5 07:56 rhel66-clone-1.qcow2
-rw-r–r–  1 root root 1.6G Jun  3 15:01 rhel66-clone.qcow2
-rw-r–r–  1 root root  81G Jun  3 13:03 rhel66.qcow2
-rw-r–r–. 1 root root  81G Jun  1 00:59 rhel71.qcow2
[root@martin-fedora vm]# export TMPDIR=/home/martin
[root@martin-fedora vm]# virt-sparsify –compress centos7-tmp.qcow2 centos7-tmp-v1.qcow2
Input disk virtual size = 85899345920 bytes (80.0G)
Create overlay file in /home/martin to protect source disk …
Examine source disk …
Fill free space in /dev/centos/root with zero …
100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00
Clearing Linux swap on /dev/centos/swap …
100% ⟦▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒⟧ 00:00
Fill free space in /dev/sda1 with zero …
Fill free space in volgroup centos with zero …
Copy to destination and make sparse …</p>

<p>Sparsify operation completed with no errors.  Before deleting the old disk,
carefully check that the target disk boots and works correctly.
[root@martin-fedora vm]# ll -h
total 12G
-rw-r–r–  1 qemu qemu  81G Jun  5 22:36 centos7-tmp.qcow2
-rw-r–r–  1 root root  81G Jun  5 22:34 centos7-tmp.qcow2.bk
-rw-r–r–  1 root root 520M Jun  5 23:11 centos7-tmp-v1.qcow2
-rw-r–r–  1 root root 2.9G Jun  5 07:56 rhel66-clone-1.qcow2
-rw-r–r–  1 root root 1.6G Jun  3 15:01 rhel66-clone.qcow2
-rw-r–r–  1 root root  81G Jun  3 13:03 rhel66.qcow2
-rw-r–r–. 1 root root  81G Jun  1 00:59 rhel71.qcow2</p>

<p>[/bash]</p>

<h2 id="yum-update--y">yum update -y</h2>

<ul>
  <li>
    <p>2015-07-10 : Done yum updated. 删除了不需要的Kernel，安装了unzip, 修改启动过程为直接文字启动。</p>
  </li>
  <li>
    <p>2015-11.15: update kernel to 7.1, set old kernel 1: package-cleanup –oldkernels –count=1</p>
  </li>
</ul>

<h2 id="section-5">使用方法</h2>

<p>root 密码 martinliu.cn 开机后记得一定要先修改。</p>

<p>百度网盘下载地址 [su_button url=”http://pan.baidu.com/s/1pJurap9” target=”blank” style=”stroked” size=”6” icon=”icon: codepen”]centos7-tmp-v7[/su_button]</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/#centos" title="Pages tagged centos" class="tag"><span class="term">centos</span></a><a href="/tags/#linux" title="Pages tagged linux" class="tag"><span class="term">linux</span></a><a href="/tags/#RHEL" title="Pages tagged RHEL" class="tag"><span class="term">RHEL</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/2015/06/05/e5-ae-89-e8-a3-85-e5-ae-8c-e7-be-8e-centos7-e8-99-9a-e6-8b-9f-e6-9c-ba-e6-a8-a1-e6-9d-bf/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/2015/06/05/e5-ae-89-e8-a3-85-e5-ae-8c-e7-be-8e-centos7-e8-99-9a-e6-8b-9f-e6-9c-ba-e6-a8-a1-e6-9d-bf/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/2015/06/05/e5-ae-89-e8-a3-85-e5-ae-8c-e7-be-8e-centos7-e8-99-9a-e6-8b-9f-e6-9c-ba-e6-a8-a1-e6-9d-bf/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="/2015/06/04/achilles-e7-9a-84-e8-84-9a-e5-90-8e-e8-b7-9f/" class="read-more-btn">阅读全文</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="/2017/01/10/clone-ahv-vm-template/" title="Nutanix AHV 虚拟机模板制作">Nutanix AHV 虚拟机模板制作</a></h3>
      <p>本文描述了AHV虚拟化的虚拟机模板的制作过程。 <a href="/2017/01/10/clone-ahv-vm-template/">阅读全文</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="/2017/01/07/nutanix-resource-sites/" title="Nutanix资源站点清单">Nutanix资源站点清单</a></h4>
        <span>Published on January 07, 2017</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="/2017/01/07/devops-glossary/" title="DevOps术语表">DevOps术语表</a></h4>
        <span>Published on January 07, 2017</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->

  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Martin Liu.</span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>



	        

</body>
</html>
