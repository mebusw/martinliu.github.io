<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; Martin's Blog</title>
<meta name="description" content="DevOps Coach & Cloud Expert">
<meta name="keywords" content="DevOps, Cloud, AWS, HCI, Nutanix, ITSM">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://martinliu.cn/images/path.jpg">

<meta name="twitter:title" content="Latest Posts">
<meta name="twitter:description" content="DevOps Coach & Cloud Expert">
<meta name="twitter:creator" content="@zliu">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="DevOps Coach & Cloud Expert">
<meta property="og:url" content="http://martinliu.cn/page3/">
<meta property="og:site_name" content="Martin's Blog">

<meta name="google-site-verification" content="4oSwNTpy1vzip3_lt6XhkhMfImCD_DZlvL3K1k-M8qk">



<link rel="canonical" href="http://martinliu.cn/page3/">
<link href="http://martinliu.cn/feed.xml" type="application/atom+xml" rel="alternate" title="Martin's Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://martinliu.cn/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://martinliu.cn/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://martinliu.cn/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://martinliu.cn/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://martinliu.cn/images/apple-touch-icon.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://martinliu.cn/images/apple-touch-icon-72x72.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://martinliu.cn/images/apple-touch-icon-114x114.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://martinliu.cn/images/apple-touch-icon-144x144.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://martinliu.cn/">首页</a></li>
		<li>
			<a href="#">关于</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://martinliu.cn/images/avatar.jpg" alt="Martin Liu photo" class="author-photo">
					<h4>Martin Liu</h4>
					<p>DevOps Coach, Cloud Expert, Runner</p>
				</li>
				<li><a href="http://martinliu.cn/about/"><span class="btn btn-inverse">详情</span></a></li>
				<li>
					<a href="mailto:67120666@qq.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/zliu"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				<li>
					<a href="https://google.com/+MartinLiu-cn"><i class="fa fa-fw fa-google-plus"></i> Google+</a>
				</li>
				<li>
					<a href="https://linkedin.com/in/liuzheng"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="https://github.com/martinliu"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">文章</a>
			<ul class="dl-submenu">
				<li><a href="http://martinliu.cn/posts/">所有文章</a></li>
				<li><a href="http://martinliu.cn/tags/">所有分类</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="http://www.aws-faq.com" target="_blank">AWS-FAQ</a></li>
	  
	    
	    <li><a href="http://devopscoach.org" target="_blank">DevOps教练</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="http://martinliu.cn/images/path.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Martin's Blog</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-11-07T23:19:08+08:00"><a href="http://martinliu.cn/2016/11/07/exin-devops-master-e8-ae-a4-e8-af-81-e8-80-83-e8-af-95/">November 07, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://martinliu.cn/about/" title="About Martin Liu">Martin Liu</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://martinliu.cn/2016/11/07/exin-devops-master-e8-ae-a4-e8-af-81-e8-80-83-e8-af-95/" rel="bookmark" title="EXIN DevOps Master 认证考试" itemprop="url">EXIN DevOps Master 认证考试</a></h1>
    
  </header>
  <div class="entry-content">
    <p>DevOps这个词在去年参加红帽全球用户大会的时候就深深吸引了我，实际上哪个会上Docker容器的概念要比DevOps还火爆。Docker／openshift相关的session都尝尝是爆满的。从那里开始我逐渐感觉到了开源容器技术的强大和吸引力。</p>

<p>从红帽开始OpenShift的考试就是我在完成RHCA红帽认证架构师之后的一个心结，至今也没有完成。不过这根草我早晚是要拔掉的。主要是由于OpenShift是Docker ＋ kubernetes 的组合；是如今企业级PaaS容器平台的主要技术路线。总之离开红帽是如此的仓促，说实话这也是我职业生涯中的一个不小的遗憾。当时确实觉得 kubernetes 的命令行操作不是很方便，而且在OpenShift并没有降低这个门槛，也即是说在OpenShift里面还是要有一定的工作量和技能的要求在编写kubernetes的yml文件上。在这一点上，及时我熟练掌握了Rancher之后，同样发现编写compose file也是难以逃避的。在推广一步，大部分Docker PaaS平台也都是这样，很多产品也是在界面上提供一个文本输入框，让人输入容器服务定义文件的内容。</p>

<p>在最近的半年中，我的所有技术研究都集中在Docker和其服务编排技术上。与很多用户做过技术交流，PoC测试，有些单子也落地。总结后，有些结果让我感叹。国内的所有企业不区分规模和行业，其实他们对国内原生的创业公司是欢迎的，由于这些公司提供的是国产软件和技术服务。在Docker这个火热的领域中，已经有20多家国内创业公司，我想所有的公司也都已经接受到了这一点的福利了。外国软件通常给人的感觉是：不是国产软件（不要小看国内公司对国产软件的诉求），纯英文操作界面和文档，可能的水土不服，高昂的软件价格和服务费，如果技术太新的化很可能厂商也不具备足够的技术实力和服务力量。</p>

<p>经过了一些Docker容器项目之后，可以断言的是容器市场的火爆和它的技术优势是直接相关的。容器化之后的应用可以通过服务编排工具快速地部署／更新、弹性地伸缩和使用资源，优化其传统应用运维的若干缺陷。容器的轻量和just enough的隔离技术让资源池的管理更加简单，利用率大幅度提升，这对研发部门的环境管理是不小的提升，使CI的过程更加高效和经济。Docker对微服务的支持也深深地诱惑了所有开发者，做系统微服务实施开发者能想到的实施技术大多数会是容器。</p>

<p>以上容器的优势和特性使得国内的这些项目落地和实施的可能性进一步提高，甚至很多项目的速度远远超预期；按照我多年的经验看，一个软件技术型的项目，用户纠结半年到一年以上是很正常的。可能也跟国内企业包容本土化软件公司，追捧新潮技术直接相关；我观察到的一些项目，在2～4个月内落单的屡见不鲜。有些试点的DevOps咨询项目也落地很快。</p>

<p>这些项目都殊途同归地指向了DevOps这个关键词，这让我不得不从去年开始就关注和学习这个最佳实践。当然，我对DevOps的前途非常看好，因此当我听说业内出现了相关认证考试之后，我毫不犹豫地报名参加了。经过2个多月的缜密的准备，我终于幸运地一次通过了这个考试。考试获得了两个证书。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/11/EXIN-DevOps-Master-Cert-Martin-Liu.jpg" alt="exin-devops-master-cert-martin-liu" /> DevOps Master</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/11/certificate-devops-freelance-trainer-Liu-Zheng.jpg" alt="DevOps Master 认证自由讲师" /> DevOps Master 认证自由讲师</p>

<p>我参加的是讲师认证培训TTT，很高兴能成为Exin在国内的首批5个认证人员之一。在准备这个考试的过程中我学习了一些书籍，现在还在深度学习的书有两本。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/11/14678659256890.jpg" alt="14678659256890" /></p>

<p>我完成了这本黑皮书的读书笔记，很遗憾的是，我发现它的最新版，把封面改成了白底的了，我不能在叫它黑皮书／黑宝书了。这本书我起码看了两遍；目前正在调试它的书中的代码，代码中的营养还是很高的，计划尽快把所有代码调试通过；从而完成我许下多次的线上分享本书的诺言。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/11/14749866044733.jpg" alt="14749866044733" /></p>

<p>这本书被我称为CD红皮书／红宝书。本书早在10年就出版了，也就是说比Docker早好多年。他给我最大的印象就是，作者每一页上似乎都在介绍这做事情的原则和规矩是什么？我一点也不夸张，他对CD的介绍，就是通过讲解一系列在项目上的经验总结。对作者这种级别的经验，和写书的房子只能用一个词总结“服”。这本书太干，我至今还没有消化完。他让我看到了解决发布和变更风险的终极解决方案，没有一次性解决问题的部署／配置／发布工具，有的是历练和打磨了千万次的持续部署流水线；隐约地觉得没用入手的企业都会慢慢跟上的。</p>

<p>以上是我对DevOps的阶段性总结，跨度有半年之久。这半年中我逐渐看清了我的主要兴趣点，抛除所有其他主题，目前剩下的就是：云计算和DevOps。一方面觉得年纪不饶人，不能可能在和年轻人拼精力、体力和创意；我的背景和经验都让我感觉，在这两个话题上，我还是有很多年的经验和技术积累和总结的。云计算是（公有云＋私有云）未来企业IT基础架构的走向；DevOps是目前看比较正确的运作实践。一个便技术，一个便管理，正好完整覆盖了我的经验；在其对应的开源技术这个分支里，我想它们都还有这很多的为探索和研究的项目。</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-07-01T11:11:10+08:00"><a href="http://martinliu.cn/2016/07/01/devops-in-a-box/">July 01, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://martinliu.cn/about/" title="About Martin Liu">Martin Liu</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~13 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://martinliu.cn/2016/07/01/devops-in-a-box/" rel="bookmark" title="DevOps 的起点-入手微型数据中心" itemprop="url">DevOps 的起点-入手微型数据中心</a></h1>
    
  </header>
  <div class="entry-content">
    <h2 id="section">测试环境说明</h2>

<p>我的笔记本电脑的环境描述如下。</p>

<h3 id="os">OS</h3>

<p>MacBook Pro 2011 版， 2.3 GHz Intel Core i5， 8GB DDR3， 256 GB SSD。 OS X EI Capitan version 10.11.5</p>

<h3 id="docker">Docker</h3>

<p>Docker for Mac Version 1.12.0-rc2-beta17 (build: 9779)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker version
Client:
 Version:      1.12.0-rc2
 API version:  1.24
 Go version:   go1.6.2
 Git commit:   906eacd
 Built:        Fri Jun 17 20:35:33 2016
 OS/Arch:      darwin/amd64
 Experimental: true

Server:
 Version:      1.12.0-rc2
 API version:  1.24
 Go version:   go1.6.2
 Git commit:   a7119de
 Built:        Wed Jun 29 10:03:33 2016
 OS/Arch:      linux/amd64
 Experimental: true
 
  $ docker-machine version
docker-machine version 0.8.0-rc1, build fffa6c9

martin@localhost ~/Documents                                                                                  [9:38:31]
 $ docker-compose version
docker-compose version 1.8.0-rc1, build 9bf6bc6
docker-py version: 1.8.1
CPython version: 2.7.9
OpenSSL version: OpenSSL 1.0.2h  3 May 2016


</code></pre>
</div>

<p>VirtualBox version 5.0.22r108108</p>

<h3 id="docker-">本机下载的 Docker 镜像</h3>

<p>/Users/martin/Downloads/1.12.0-rc2/boot2docker.iso</p>

<p>~/Downloads/rancher-all/rancher-agent-v1.0.1.tar</p>

<p>~/Downloads/rancher-all/rancher-agent-instance-v0.8.1.tar</p>

<p>~/Downloads/habitat-docker-registry.bintray.io-studio.tar</p>

<p>~/Downloads/rancher-all/rancher-server-stable.tar</p>

<p>我本机还有一个 Docker Registry 的 vm，这里面提供了我需要积累以后用的镜像存储，想象一下你在飞机上的时候去哪里拉取镜像 ：）</p>

<h3 id="section-1">本机下载的代码</h3>

<p>https://github.com/habitat-sh/habitat-example-plans https://github.com/janeczku/habitat-plans https://github.com/chrisurwin/may2016-demo https://github.com/docker/example-voting-app</p>

<p>注意以上代码可能需要修改才能在本机调试成功。</p>

<h2 id="rancher-">创建 Rancher 服务器</h2>

<h3 id="section-2">生成虚拟机</h3>

<p>用 docker-machine 创建 rancher 服务器。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker-machine create rancher --driver virtualbox --virtualbox-cpu-count "1" --virtualbox-disk-size "8000" --virtualbox-memory "1024" --virtualbox-boot2docker-url=/Users/martin/Downloads/1.12.0-rc2/boot2docker.iso &amp;&amp; eval $(docker-machine env rancher)

</code></pre>
</div>

<h3 id="rancher--1">导入 Rancher 服务器镜像</h3>

<p>用 docker-machine ls 应该看到 rancher 这个节点打了星号。否则 docker 命令会执行失败或者错误。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker load &lt; ~/Downloads/rancher-all/rancher-server-stable.tar
docker run -d --restart=always --name rancher-srv -p 8080:8080 rancher/server:stable 
docker logs -f rancher-srv

</code></pre>
</div>

<p>查看 rancher 服务器的 ip 地址。 docker-machine ip rancher</p>

<p>用浏览器打开Rancher 服务器的登录页面。 open http://Rancher_Server_IP:8080</p>

<p>下面是一些如何让虚拟机保持固定 IP 和 rancher 容器存储的数据持久存在的代码，我没有测试成功，留下大家一起搞，成功了，给我一个回复。另外还有关于稿 jekins 和 mirror 的代码。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>echo "ifconfig eth1 192.168.99.60 netmask 255.255.255.0 broadcast 192.168.99.255 up" | docker-machine ssh node1 sudo tee /var/lib/boot2docker/bootsync.sh &gt; /dev/null
docker-machine regenerate-certs node1 -f
docker-machine ssh ndoe1
sudo mkdir /mnt/sda1/var/lib/rancher 


docker@node1:/mnt/sda1/var/lib/boot2docker$ cat bootsync.sh
ifconfig eth1 192.168.99.60 netmask 255.255.255.0 broadcast 192.168.99.255 up

sudo mkdir /mnt/sda1/var/lib/rancher/
sudo ln -s /mnt/sda1/var/lib/rancher/ /var/lib/



docker load &lt; ~/Downloads/rancher-all/jenkins.tar

docker run -d --name jekins --privileged -p 9001:8080 -v /var/lib/docker/:/var/lib/docker/ -v /var/run/docker.sock:/var/run/docker.sock -v /usr/bin/docker:/usr/bin/docker  -v /lib64/libdevmapper.so.1.02:/usr/lib/libdevmapper.so.1.02  --label io.rancher.container.network=true jenkins


docker-machine create mirror --driver virtualbox --virtualbox-cpu-count "1" --virtualbox-disk-size "8000" --virtualbox-memory "512" --virtualbox-boot2docker-url=/Users/martin/Downloads/boot2docker.iso 

docker load &lt; ~/Downloads/rancher-all/registry.tar
docker run -d -p 80:5000 --restart=always --name registry registry:2

</code></pre>
</div>

<h2 id="rancher-agent-">容器运行节点 Rancher Agent 节点</h2>

<h3 id="node1-">创建 node1 虚拟机</h3>

<p>使用 docker-machine  命令创建容器运行节点。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker-machine create node1 --driver virtualbox --engine-insecure-registry 192.168.99.20:5000 --virtualbox-cpu-count "1" --virtualbox-disk-size "80000" --virtualbox-memory "1024" --virtualbox-boot2docker-url=/Users/martin/Downloads/1.12.0-rc2/boot2docker.iso 

docker-machine create node2 --driver virtualbox --engine-insecure-registry 192.168.99.20:5000 --virtualbox-cpu-count "1" --virtualbox-disk-size "80000" --virtualbox-memory "1024" --virtualbox-boot2docker-url=/Users/martin/Downloads/1.12.0-rc2/boot2docker.iso 

</code></pre>
</div>

<p>在 node1 或者 node2 测试运行一个容器，使用 mirror 中的 busybox 镜像。如果你的笔记本内存小于8GB 的话，node2就别搞了。一个 node 也够用了。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker pull 192.168.99.20:5000/busybox:latest 

</code></pre>
</div>

<p>docker run 一下这个镜像，验证 node1工作正常。</p>

<h3 id="rancher-agent--1">加载 Rancher Agent 的镜像</h3>

<p>确保 node1 是 docker-machine ls 中打星号的。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker load &lt; ~/Downloads/rancher-all/rancher-agent-v1.0.1.tar
docker load &lt; ~/Downloads/rancher-all/rancher-agent-instance-v0.8.1.tar
docker load &lt; ~/Downloads/habitat-docker-registry.bintray.io-studio.tar

</code></pre>
</div>

<p>你翻墙下载回来的habitat-docker-registry.bintray.io/studio镜像可能需要打标签，否则回头 hab 命令执行失败。 先用 docer images 看下是否所有 image 的标签信息正确。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker tag fc27342e5e0e habitat-docker-registry.bintray.io/studio:latest
</code></pre>
</div>

<h3 id="node1--rancher-server">添加 node1 节点到 Rancher Server。</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>docker run -d --privileged -v /var/run/docker.sock:/var/run/docker.sock -v /var/lib/rancher:/var/lib/rancher rancher/agent:v1.0.1 http://192.168.99.100:8080/v1/scripts/33B68ED65CEF18F6D7BD:1466694000000:lug2KswoXOOQV4d09ZNMGTphVs0

</code></pre>
</div>

<blockquote>注意：以上命令需要到您的 Rancher Server 的页面上获取，否则参数都是不对的。</blockquote>

<p>现在在 Hosts 页面上应该能看到该刚创建的节点。在页面上创建一个最小化的容器（如 busybox），来拉起 Network Agent 容器。</p>

<h2 id="habitat-">调试 habitat 的测试程序</h2>

<p>参考的文档 https://www.habitat.sh/tutorials/ 记得一定要把这一组文章先看完，在去调试它的代码，不懂这些基本概念的话，后面对了错了都不知道该怎么搞。</p>

<p>前置条件，翻墙下载 habitat studio 的 docker image 镜像，load 到 node1 上，下面的所有测试都是在 node1 上完成的。</p>

<h3 id="hab">安装 hab</h3>

<p>habitat 的程序只有一个可执行程序， 目前支持 mac 和 linux 版本。下载地址： https://www.habitat.sh/docs/get-habitat 就是一个 tag 包，解压缩后放到 shell 的 PATH 里面就安装完了。</p>

<h3 id="hab-cli">配置 hab cli</h3>

<p>运行 hab setup</p>

<div class="highlighter-rouge"><pre class="highlight"><code>martin@localhost ~/Documents                                                                                  $ hab setup

Habitat CLI Setup
=================

  Welcome to hab setup. Let's get started.

Set up a default origin

  Every package in Habitat belongs to an origin, which indicates the
  person or organization responsible for maintaining that package. Each
  origin also has a key used to cryptographically sign packages in that
  origin.

  Selecting a default origin tells package building operations such as
  'hab pkg build' what key should be used to sign the packages produced.
  If you do not set a default origin now, you will have to tell package
  building commands each time what origin to use.

  For more information on origins and how they are used in building
  packages, please consult the docs at
  https://www.habitat.sh/docs/build-packages-overview/

Set up a default origin? [Yes/no/quit] yes 这里输入 yes

  Enter the name of your origin. If you plan to publish your packages
  publicly, we recommend that you select one that is not already in use on
  the Habitat build service found at https://app.habitat.sh/.

  You already have a default origin set up as `martin', but feel free to
  change it if you wish.

Default origin name: [default: martin] 这是用来做 Habitat 包签名和加密用的标识，在代码里面会用到。

  You already have an origin key for martin created and installed. Great
  work!

GitHub Access Token

  While you can build and run Habitat packages without sharing them on the
  public depot, doing so allows you to collaborate with the Habitat
  community. In addition, it is how you can perform continuous deployment
  with Habitat.

  The depot uses GitHub authentication with an access token
  (https://help.github.com/articles/creating-an-access-token-for-command-line-use/).

  If you would like to share your packages on the depot, please enter your
  GitHub access token. Otherwise, just enter No.

  For more information on sharing packages on the depot, please read the
  documentation at https://www.habitat.sh/docs/share-packages-overview/

Set up a default GitHub access token? [Yes/no/quit] yes 这里选择yes

  Enter your GitHub access token.

  You already have a default auth token set up, but feel free to change it
  if you wish.

GitHub access token: [default: martin-github-token]  这个 token 需要自己去 github 里面生成

Analytics

  The `hab` command-line tool will optionally send anonymous usage data to
  Habitat's Google Analytics account. This is a strictly opt-in activity
  and no tracking will occur unless you respond affirmatively to the
  question below.

  We collect this data to help improve Habitat's user experience. For
  example, we would like to know the category of tasks users are
  performing, and which ones they are having trouble with (e.g. mistyping
  command line arguments).

  To see what kinds of data are sent and how they are anonymized, please
  read more about our analytics here:
  https://www.habitat.sh/docs/about-analytics/

Enable analytics? [yes/No/quit] no 这里选择 no
» Opting out of analytics
☑ Creating /Users/martin/.hab/cache/analytics/OPTED_OUT
★ Analytics opted out, we salute you just the same!

CLI Setup Complete

  That's all for now. Thanks for using Habitat!


martin@localhost ~/Documents                                                                                 $

</code></pre>
</div>

<p>该注意的都写到上面的代码里面了。这个配置的结果在这里</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cat ~/.hab/etc/cli.toml
auth_token = "martin-github-token"
origin = "martin"

</code></pre>
</div>

<h3 id="habitat-demo-">调试 Habitat demo 应用</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/habitat-sh/habitat-example-plans
</code></pre>
</div>

<p>进入到 mytutorialapp 目录，修改 plan.sh 的 第二行代码，我改后的代码是</p>

<div class="highlighter-rouge"><pre class="highlight"><code>pkg_origin=martin
</code></pre>
</div>

<p>martin 是我在 hab cli 里面配置的 origin。</p>

<p>其实下面的测试就执行了两个 hab 的命令，都是在 hab studi 的 shell里面执行的，这个 shell 其实就是一个studio 容器的 shell。</p>

<p>在运行下面的命令，确保你是和 node1正常通讯的，下面我用 default 节点做演示。做完的演示环境我已经删除了。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker-machine ls                                                                                      NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER    ERRORS
default   -        virtualbox   Running   tcp://192.168.99.100:2376           v1.11.1

$ docker ps                                                                                              CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES


</code></pre>
</div>

<p>正常的意思是执行所有 docker 命令不报错。</p>

<h3 id="build-habitat-demo-">build habitat demo 代码</h3>

<p>进入到代码的 plan.sh 的目录 执行 hab studio enter 命令。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>martin@localhost ~/Documents/GitHub/habitat-example-plans/mytutorialapp                                      
 $ hab studio enter                                                                                       [±master ●●]
   hab-studio: Creating Studio at /hab/studios/src (default)
   hab-studio: Importing martin secret origin key
» Importing origin key from standard input
★ Imported secret origin key martin-20160630040241.
   hab-studio: Entering Studio at /hab/studios/src (default)
   hab-studio: Exported: HAB_ORIGIN=martin

[1][default:/src:0]# build
   : Loading /src/plan.sh
   mytutorialapp: Plan loaded
   mytutorialapp: hab-plan-build setup
   mytutorialapp: Using HAB_BIN=/hab/pkgs/core/hab/0.7.0/20160614230104/bin/hab for installs, signing, and hashing
   mytutorialapp: Resolving dependencies
» Installing core/node
→ Using core/gcc-libs/5.2.0/20160612075020
→ Using core/glibc/2.22/20160612063629
→ Using core/linux-headers/4.3/20160612063537
↓ Downloading core/node/4.2.6/20160612143531
    6.44 MB / 6.44 MB \ [=======================================================================] 100.00 % 457.82 KB/s  ↓ Downloading core-20160612031944 public origin key
    75 B / 75 B | [=============================================================================] 100.00 % 575.13 KB/s  ☑ Cached core-20160612031944 public origin key
✓ Installed core/node/4.2.6/20160612143531
★ Install of core/node complete with 4 packages installed.
   mytutorialapp: Resolved dependency 'core/node' to /hab/pkgs/core/node/4.2.6/20160612143531
   mytutorialapp: Setting PATH=/hab/pkgs/core/node/4.2.6/20160612143531/bin:/hab/pkgs/core/hab-plan-build/0.7.0/20160614232259/bin:/hab/pkgs/core/bash/4.3.42/20160612075613/bin:/hab/pkgs/core/binutils/2.25.1/20160612064534/bin:/hab/pkgs/core/bzip2/1.0.6/20160612075040/bin:/hab/pkgs/core/coreutils/8.24/20160612075329/bin:/hab/pkgs/core/file/5.24/20160612064523/bin:/hab/pkgs/core/findutils/4.4.2/20160612080341/bin:/hab/pkgs/core/gawk/4.1.3/20160612075739/bin:/hab/pkgs/core/grep/2.22/20160612075540/bin:/hab/pkgs/core/gzip/1.6/20160612080637/bin:/hab/pkgs/core/hab/0.7.0/20160614230104/bin:/hab/pkgs/core/sed/4.2.2/20160612075228/bin:/hab/pkgs/core/tar/1.28/20160612075701/bin:/hab/pkgs/core/unzip/6.0/20160612081414/bin:/hab/pkgs/core/wget/1.16.3/20160612081342/bin:/hab/pkgs/core/xz/5.2.2/20160612080402/bin:/hab/pkgs/core/acl/2.2.52/20160612075215/bin:/hab/pkgs/core/attr/2.4.47/20160612075207/bin:/hab/pkgs/core/glibc/2.22/20160612063629/bin:/hab/pkgs/core/less/481/20160612080021/bin:/hab/pkgs/core/libcap/2.24/20160612075226/bin:/hab/pkgs/core/libidn/1.32/20160612081104/bin:/hab/pkgs/core/ncurses/6.0/20160612075116/bin:/hab/pkgs/core/openssl/1.0.2h/20160612081127/bin:/hab/pkgs/core/pcre/8.38/20160612075520/bin
mkdir: created directory '/hab/cache/src'
   mytutorialapp: Downloading 'https://s3-us-west-2.amazonaws.com/mytutorialapp/mytutorialapp-0.1.0.tar.gz' to 'mytutorialapp-0.1.0.tar.gz'
--2016-07-01 02:27:51--  https://s3-us-west-2.amazonaws.com/mytutorialapp/mytutorialapp-0.1.0.tar.gz
Resolving s3-us-west-2.amazonaws.com (s3-us-west-2.amazonaws.com)... 54.231.184.216
Connecting to s3-us-west-2.amazonaws.com (s3-us-west-2.amazonaws.com)|54.231.184.216|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1041 (1.0K) [application/x-gzip]
Saving to: 'mytutorialapp-0.1.0.tar.gz'

mytutorialapp-0.1.0.tar.gz    100%[===================================================&gt;]   1.02K  --.-KB/s   in 0.03s

2016-07-01 02:28:08 (32.1 KB/s) - 'mytutorialapp-0.1.0.tar.gz' saved [1041/1041]

   mytutorialapp: Downloaded 'mytutorialapp-0.1.0.tar.gz'
   mytutorialapp: Verifying mytutorialapp-0.1.0.tar.gz
   mytutorialapp: Checksum verified for mytutorialapp-0.1.0.tar.gz
   mytutorialapp: Clean the cache
   mytutorialapp: Unpacking mytutorialapp-0.1.0.tar.gz
   mytutorialapp: Setting build environment
   mytutorialapp: Setting PREFIX=/hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725
   mytutorialapp: Setting LD_RUN_PATH=/hab/pkgs/core/node/4.2.6/20160612143531/lib
   mytutorialapp: Setting CFLAGS=-I/hab/pkgs/core/node/4.2.6/20160612143531/include
   mytutorialapp: Setting LDFLAGS=-L/hab/pkgs/core/node/4.2.6/20160612143531/lib
   mytutorialapp: Preparing to build
   mytutorialapp: Building
npm WARN package.json mytutorialapp@0.1.0 No repository field.
npm WARN package.json mytutorialapp@0.1.0 No README data
nconf@0.8.4 node_modules/nconf
├── ini@1.3.4
├── secure-keys@1.0.0
├── async@1.5.2
└── yargs@3.32.0 (decamelize@1.2.0, camelcase@2.1.1, window-size@0.1.4, y18n@3.2.1, os-locale@1.4.0, cliui@3.2.0, string-width@1.0.1)
   mytutorialapp: Installing
'node_modules/nconf' -&gt; '/hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725/node_modules/nconf'

忽略了好几百行输出

'node_modules/nconf/node_modules/secure-keys/test/simple-test.js' -&gt; '/hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725/node_modules/nconf/node_modules/secure-keys/test/simple-test.js'
'node_modules/nconf/node_modules/secure-keys/test/test.secret.key' -&gt; '/hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725/node_modules/nconf/node_modules/secure-keys/test/test.secret.key'
'node_modules/nconf/node_modules/secure-keys/package.json' -&gt; '/hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725/node_modules/nconf/node_modules/secure-keys/package.json'
   mytutorialapp: Writing configuration
   mytutorialapp: Writing service management scripts
   mytutorialapp: Stripping unneeded symbols from binaries and libraries
   mytutorialapp: Creating manifest
   mytutorialapp: Building package metadata
   mytutorialapp: Generating blake2b hashes of all files in the package
   mytutorialapp: Generating signed metadata FILES
» Signing mytutorialapp_blake2bsums
☛ Signing mytutorialapp_blake2bsums with martin-20160630040241 to create /hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725/FILES
★ Signed artifact /hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725/FILES.
   mytutorialapp: Generating package artifact
/hab/pkgs/core/tar/1.28/20160612075701/bin/tar: Removing leading `/' from member names
/hab/cache/artifacts/.martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.tar (1/1)
  100 %       121.4 KiB / 900.0 KiB = 0.135
» Signing /hab/cache/artifacts/.martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.tar.xz
☛ Signing /hab/cache/artifacts/.martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.tar.xz with martin-20160630040241 to create /hab/cache/artifacts/martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.hart
★ Signed artifact /hab/cache/artifacts/martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.hart.
'/hab/cache/artifacts/martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.hart' -&gt; '/src/results/martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.hart'
   mytutorialapp: hab-plan-build cleanup
   mytutorialapp:
   mytutorialapp: Source Cache: /hab/cache/src/mytutorialapp-0.1.0
   mytutorialapp: Installed Path: /hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725
   mytutorialapp: Artifact: /src/results/martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.hart
   mytutorialapp: Build Report: /src/results/last_build.env
   mytutorialapp: SHA256 Checksum: d4bfb3a44989b8a5b1295eac2600d75f42dd2be6f537344312c8917cba47d05d
   mytutorialapp: Blake2b Checksum: fbff257eb36fffa61e6cbf5ec89fa3f507095f80f5cca610c2bb72685d758706
   mytutorialapp:
   mytutorialapp: I love it when a plan.sh comes together.
   mytutorialapp:
   mytutorialapp: Build time: 1m3s
[2][default:/src:0]#

</code></pre>
</div>

<p>检查结果，在代码的目录中可以看的 result 目录，关注一下这个目录，关键看 build 命令的最后一段。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
mytutorialapp: hab-plan-build cleanup mytutorialapp: mytutorialapp: Source Cache: /hab/cache/src/mytutorialapp-0.1.0 mytutorialapp: Installed Path: /hab/pkgs/martin/mytutorialapp/0.1.0/20160701022725 mytutorialapp: Artifact: /src/results/martin-mytutorialapp-0.1.0-20160701022725-x86_64-linux.hart mytutorialapp: Build Report: /src/results/last_build.env mytutorialapp: SHA256 Checksum: d4bfb3a44989b8a5b1295eac2600d75f42dd2be6f537344312c8917cba47d05d mytutorialapp: Blake2b Checksum: fbff257eb36fffa61e6cbf5ec89fa3f507095f80f5cca610c2bb72685d758706 mytutorialapp: mytutorialapp: I love it when a plan.sh comes together. mytutorialapp: mytutorialapp: Build time: 1m3s

</code></pre>
</div>

<h3 id="habitat--docker-image">昨晚分享的高潮部分, habitat 导出 docker image</h3>

<p>其实就是一条命令，在 habitat Studio 中执行 导出命令 hab pkg export docker martin/mytutorialapp</p>

<p>导出 docker 镜像的过程和 build 的过程一样，都可能会失败；由于它需要到网上下载所需要的代码，下载所需要的 habitat 模块，core/ 开头的都是 habitat出品的核心的模块，他们的想法基本也是说把所有的可能用到的模块都做封装，成为自己的 pkg 格式的内容。然后在用他们的 Habitat 服务来解析、部署和运行。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[4][default:/src:0]#  hab pkg export docker martin/mytutorialapp
   hab-studio: Creating Studio at /tmp/hab-pkg-dockerize-XxsS/rootfs (baseimage)
 Using local package for martin/mytutorialapp
 Using local package for core/gcc-libs/5.2.0/20160612075020 via martin/mytutorialapp
 Using local package for core/glibc/2.22/20160612063629 via martin/mytutorialapp
 Using local package for core/linux-headers/4.3/20160612063537 via martin/mytutorialapp
 Using local package for core/node/4.2.6/20160612143531 via martin/mytutorialapp
» Installing core/hab
↓ Downloading core/hab/0.7.0/20160614230104
    2.23 MB / 2.23 MB / [=======================================================================] 100.00 % 500.60 KB/s  ↓ Downloading core-20160612031944 public origin key
    75 B / 75 B | [=============================================================================] 100.00 % 378.76 KB/s  ☑ Cached core-20160612031944 public origin key
✓ Installed core/hab/0.7.0/20160614230104
★ Install of core/hab complete with 1 packages installed.
» Installing core/hab-sup
↓ Downloading core/busybox-static/1.24.2/20160612081725
    510.89 KB / 510.89 KB | [====================================================================] 100.00 % 89.61 KB/s  ✓ Installed core/busybox-static/1.24.2/20160612081725
↓ Downloading core/bzip2/1.0.6/20160612075040
    141.05 KB / 141.05 KB - [===================================================================] 100.00 % 349.94 KB/s  ✓ Installed core/bzip2/1.0.6/20160612075040
↓ Downloading core/cacerts/2016.04.20/20160612081125
    132.32 KB / 132.32 KB | [===================================================================] 100.00 % 370.21 KB/s  ✓ Installed core/cacerts/2016.04.20/20160612081125
→ Using core/gcc-libs/5.2.0/20160612075020
→ Using core/glibc/2.22/20160612063629
↓ Downloading core/libarchive/3.2.0/20160612140528
    584.98 KB / 584.98 KB | [===================================================================] 100.00 % 340.75 KB/s  ✓ Installed core/libarchive/3.2.0/20160612140528
↓ Downloading core/libsodium/1.0.8/20160612140317
    187.96 KB / 187.96 KB \ [===================================================================] 100.00 % 200.27 KB/s  ✓ Installed core/libsodium/1.0.8/20160612140317
→ Using core/linux-headers/4.3/20160612063537
↓ Downloading core/openssl/1.0.2h/20160612081127
    2.10 MB / 2.10 MB | [=======================================================================] 100.00 % 518.78 KB/s  ✓ Installed core/openssl/1.0.2h/20160612081127
↓ Downloading core/xz/5.2.2/20160612080402
    247.38 KB / 247.38 KB \ [===================================================================] 100.00 % 468.42 KB/s  ✓ Installed core/xz/5.2.2/20160612080402
↓ Downloading core/zlib/1.2.8/20160612064520
    73.06 KB / 73.06 KB / [=====================================================================] 100.00 % 315.44 KB/s  ✓ Installed core/zlib/1.2.8/20160612064520
↓ Downloading core/hab-sup/0.7.0/20160614232939
    1.54 MB / 1.54 MB | [=======================================================================] 100.00 % 563.90 KB/s  ✓ Installed core/hab-sup/0.7.0/20160614232939
★ Install of core/hab-sup complete with 12 packages installed.
» Symlinking hab from core/hab into /tmp/hab-pkg-dockerize-XxsS/rootfs/hab/bin
★ Binary hab from core/hab/0.7.0/20160614230104 symlinked to /tmp/hab-pkg-dockerize-XxsS/rootfs/hab/bin/hab
» Symlinking bash from core/busybox-static into /tmp/hab-pkg-dockerize-XxsS/rootfs/bin
★ Binary bash from core/busybox-static/1.24.2/20160612081725 symlinked to /tmp/hab-pkg-dockerize-XxsS/rootfs/bin/bash
» Symlinking sh from core/busybox-static into /tmp/hab-pkg-dockerize-XxsS/rootfs/bin
★ Binary sh from core/busybox-static/1.24.2/20160612081725 symlinked to /tmp/hab-pkg-dockerize-XxsS/rootfs/bin/sh
Sending build context to Docker daemon 194.3 MB
Step 1 : FROM scratch
 ---&gt;
Step 2 : ENV export PATH=:/hab/pkgs/core/glibc/2.22/20160612063629/bin:/hab/pkgs/core/node/4.2.6/20160612143531/bin:/hab/pkgs/core/hab-sup/0.7.0/20160614232939/bin:/hab/pkgs/core/busybox-static/1.24.2/20160612081725/bin:/hab/pkgs/core/bzip2/1.0.6/20160612075040/bin:/hab/pkgs/core/glibc/2.22/20160612063629/bin:/hab/pkgs/core/openssl/1.0.2h/20160612081127/bin:/hab/pkgs/core/xz/5.2.2/20160612080402/bin:/hab/pkgs/core/busybox-static/1.24.2/20160612081725/bin:/hab/bin
 ---&gt; Running in 117e90c151e7
 ---&gt; 7f33585a25ae
Removing intermediate container 117e90c151e7
Step 3 : WORKDIR /
 ---&gt; Running in 952257966d96
 ---&gt; c0cf3715cbcf
Removing intermediate container 952257966d96
Step 4 : ADD rootfs /
 ---&gt; d2691da93ccf
Removing intermediate container 4aa80e97ea57
Step 5 : VOLUME /hab/svc/mytutorialapp/data /hab/svc/mytutorialapp/config
 ---&gt; Running in f1edcb653432
 ---&gt; bd8888453939
Removing intermediate container f1edcb653432
Step 6 : EXPOSE 9631 8080
 ---&gt; Running in 9ca7725ed13e
 ---&gt; 256a04cd0fe2
Removing intermediate container 9ca7725ed13e
Step 7 : ENTRYPOINT /init.sh
 ---&gt; Running in 81930dff8f4e
 ---&gt; d7bdec08530e
Removing intermediate container 81930dff8f4e
Step 8 : CMD start martin/mytutorialapp
 ---&gt; Running in c8cc53d92bc8
 ---&gt; 8d5e0fe85395
Removing intermediate container c8cc53d92bc8
Successfully built 8d5e0fe85395
[5][default:/src:0]#

</code></pre>
</div>

<p>查看 docker 镜像是否存在。推出 studio 容器，运行 docker images</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[5][default:/src:0]# exit
logout

martin@localhost ~/Documents/GitHub/habitat-example-plans/mytutorialapp                                       $ docker images                                                                                          [±master ●●]
REPOSITORY                                  TAG                    IMAGE ID            CREATED             SIZE
martin/mytutorialapp                        0.1.0-20160701024401   8d5e0fe85395        3 minutes ago       187.7 MB
martin/mytutorialapp                        latest                 8d5e0fe85395        3 minutes ago       187.7 MB


</code></pre>
</div>

<h3 id="demo">运行这个 demo</h3>

<p>在命令行运行</p>

<p>$ docker run -it -p 8080:8080 martin/mytutorialapp</p>

<p>用浏览器打开 node1的 ip 8080 端口，应该可以看到 hello world 页面。</p>

<p>在 rancher web 页面添加测试</p>

<h3 id="rancher--demo">在 rancher 中上架这个 demo</h3>

<p>https://github.com/martinliu/hab-catalog 以上代码是半成品，欢迎协助完成。</p>

<h3 id="rancher--redis-demo">测试 Rancher 官方的 redis demo</h3>

<p>参考文章 http://rancher.com/using-habitat-to-create-rancher-catalog-templates/ 它的 demo 和上架的目录都可以正常测试通过，但是服务运行不起来，报主机名错误，redis 节点的群集建立不起来。</p>

<p>如果您修复了，请回复贴出代码位置。</p>

<h2 id="docker--1">福利：调试 docker 官方投票应用</h2>

<p>下载投票实例程序。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/martinliu/example-voting-app.git

</code></pre>
</div>

<p>进入该程序的目录，修改所有 image 的来源镜像库，修改为指向本地的 mirror 服务器。 1. result/tests/Dcokerfile -&gt; FROM 192.168.99.20:5000/node 2. result/Dockerfile -&gt; FROM 192.168.99.20:5000/node:5.11.0-slim 3. vote/Dockerfile -&gt; FROM 192.168.99.20:5000/python:2.7-alpine 4. worker/Dockerfile -&gt; FROM 192.168.99.20:5000/microsoft/dotnet:1.0.0-preview1 5. docker-compose.yml -&gt; image: 192.168.99.20:5000/redis:alpine 6. docker-compose.yml -&gt; image: 192.168.99.20:5000/postgres:9.4</p>

<p>由于以上应用在构建的过程中需要在线安装各种软件包，最好先翻墙，确认你有足够稳定的国外的互联网访问，建议翻墙到美国，然后在执行项目的构建命令。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ping facebook.com
64 bytes from 173.252.90.132: icmp_seq=0 ttl=79 time=4187.066 ms
64 bytes from 173.252.90.132: icmp_seq=1 ttl=79 time=3186.904 ms
64 bytes from 173.252.90.132: icmp_seq=2 ttl=79 time=2515.415 ms
64 bytes from 173.252.90.132: icmp_seq=6 ttl=79 time=296.457 ms
64 bytes from 173.252.90.132: icmp_seq=7 ttl=79 time=410.215 ms
^C
--- facebook.com ping statistics ---
8 packets transmitted, 5 packets received, 37.5% packet loss
round-trip min/avg/max/stddev = 296.457/2119.211/4187.066/1537.275 ms

docker-compose build


</code></pre>
</div>

<p>以上结果表明，翻墙成功，以上结果显示翻墙的效果比较差，延迟和丢包都比较严重，可能到只构建的时候下载软件包失败。</p>

<p>构建完毕之后，可以检查一下是否生产了目标镜像文件，如果输出如下所示，则表明本次本地的项目集成构建成功。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker images                                                                                                                            
REPOSITORY                            TAG                 IMAGE ID            CREATED             SIZE
examplevotingapp_result               latest              9bb4126b0905        5 minutes ago       225.8 MB
examplevotingapp_worker               latest              292396a5aba4        6 minutes ago       644.1 MB
examplevotingapp_vote                 latest              28052191beea        10 minutes ago      68.31 MB


</code></pre>
</div>

<p>在当前 node1 节点上做本地的集成结果的功能测试，用 docker-compose 启动这个项目。先检查 compose 文件，然后运行 up。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker-compose config                                                                                                                      
networks: {}
services:
  db:
    image: 192.168.99.20:5000/postgres:9.4
  redis:
    image: 192.168.99.20:5000/redis:alpine
    ports:
    - '6379'
  result:
    build:
      context: /Users/martin/Documents/GitHub/example-voting-app/result
    command: nodemon --debug server.js
    ports:
    - 5001:80
    - 5858:5858
    volumes:
    - /Users/martin/Documents/GitHub/example-voting-app/result:/app:rw
  vote:
    build:
      context: /Users/martin/Documents/GitHub/example-voting-app/vote
    command: python app.py
    ports:
    - 5000:80
    volumes:
    - /Users/martin/Documents/GitHub/example-voting-app/vote:/app:rw
  worker:
    build:
      context: /Users/martin/Documents/GitHub/example-voting-app/worker
version: '2.0'
volumes: {}

$ docker-compose up                                                                                                                            
Recreating examplevotingapp_vote_1
Recreating examplevotingapp_worker_1
Starting examplevotingapp_db_1
Starting examplevotingapp_redis_1
Recreating examplevotingapp_result_1
Attaching to examplevotingapp_db_1, examplevotingapp_redis_1, examplevotingapp_worker_1, examplevotingapp_result_1, examplevotingapp_vote_1
redis_1   |                 _._
redis_1   |            _.-``__ ''-._
redis_1   |       _.-``    `.  `_.  ''-._           Redis 3.2.1 (00000000/0) 64 bit
redis_1   |   .-`` .-```.  ```\/    _.,_ ''-._
db_1      | LOG:  database system was shut down at 2016-06-20 09:58:19 UTC
redis_1   |  (    '      ,       .-`  | `,    )     Running in standalone mode
redis_1   |  |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379
redis_1   |  |    `-._   `._    /     _.-'    |     PID: 1
redis_1   |   `-._    `-._  `-./  _.-'    _.-'
redis_1   |  |`-._`-._    `-.__.-'    _.-'_.-'|
redis_1   |  |    `-._`-._        _.-'_.-'    |           http://redis.io
redis_1   |   `-._    `-._`-.__.-'_.-'    _.-'
redis_1   |  |`-._`-._    `-.__.-'    _.-'_.-'|
db_1      | LOG:  MultiXact member wraparound protections are now enabled
redis_1   |  |    `-._`-._        _.-'_.-'    |
redis_1   |   `-._    `-._`-.__.-'_.-'    _.-'
db_1      | LOG:  database system is ready to accept connections
redis_1   |       `-._    `-.__.-'    _.-'
redis_1   |           `-._        _.-'
redis_1   |               `-.__.-'
redis_1   |
redis_1   | 1:M 20 Jun 10:13:36.216 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
redis_1   | 1:M 20 Jun 10:13:36.216 # Server started, Redis version 3.2.1
redis_1   | 1:M 20 Jun 10:13:36.216 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
db_1      | LOG:  autovacuum launcher started
redis_1   | 1:M 20 Jun 10:13:36.216 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
redis_1   | 1:M 20 Jun 10:13:36.216 * The server is now ready to accept connections on port 6379
vote_1    |  * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
vote_1    |  * Restarting with stat
result_1  | [nodemon] 1.9.2
result_1  | [nodemon] to restart at any time, enter `rs`
result_1  | [nodemon] watching: *.*
result_1  | [nodemon] starting `node --debug server.js`
result_1  | Debugger listening on port 5858
vote_1    |  * Debugger is active!
vote_1    |  * Debugger pin code: 139-254-286
worker_1  | Found redis at 172.19.0.2
result_1  | Mon, 20 Jun 2016 10:13:40 GMT body-parser deprecated bodyParser: use individual json/urlencoded middlewares at server.js:67:9
result_1  | Mon, 20 Jun 2016 10:13:40 GMT body-parser deprecated undefined extended: provide extended option at ../node_modules/body-parser/index.js:105:29
result_1  | App running on port 80
result_1  | Connected to db


</code></pre>
</div>

<p>打开浏览器测试 vote 应用。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>open http://192.168.99.114:5000


</code></pre>
</div>

<p>正常显示结果如下图所示： <img src="http://yzd.io/images/voting-1.jpg" alt="voting" /></p>

<p>打开浏览器测试 result 应用。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>open http://192.168.99.114:5001


</code></pre>
</div>

<p>正常显示结果如下图所示： <img src="http://yzd.io/images/result-1.jpg" alt="result" /></p>

<p>在 Rancher 的 hosts 界面中应该看到这些运行的容器。 <img src="http://yzd.io/images/voting-in-rancher-1.jpg" alt="voting-in-ranche" /></p>

<p>至此所有关于应用构建和功能测试的过程完成，按 ctl + c 结束 docker-compose up 的运行。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>^CGracefully stopping... (press Ctrl+C again to force)
Stopping examplevotingapp_worker_1 ... done
Stopping examplevotingapp_result_1 ... done
Stopping examplevotingapp_vote_1 ... done
Stopping examplevotingapp_db_1 ... done
Stopping examplevotingapp_redis_1 ... done

</code></pre>
</div>


  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-06-23T00:22:51+08:00"><a href="http://martinliu.cn/2016/06/23/building-serverless-apps-docker/">June 23, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://martinliu.cn/about/" title="About Martin Liu">Martin Liu</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://martinliu.cn/2016/06/23/building-serverless-apps-docker/" rel="bookmark" title="用 Docker 构建 Serverless 应用" itemprop="url">用 Docker 构建 Serverless 应用</a></h1>
    
  </header>
  <div class="entry-content">
    <h2 id="martinserverless">Martin解读Serverless</h2>

<p>Serverless 不意味着没有服务器，而是从应用可以在一个抽象层上忽略它的存在，而只关注在功能实现上和自身的请求处理上；每一个功能实现在不是单纯的业务逻辑处理的代码，相反每个功能调用具有了 server 的特质，进化成为了一个具有自省、自知和自治的工作负载单元；他们更像是能够衍生出其它新功能单元的生物体。这样整个 Serverless 应用架构之内，每个生命可以衍生下去，子子孙孙无穷匮也。</p>

<p>本文编译了：<a href="https://blog.docker.com/2016/06/building-serverless-apps-with-docker/">https://blog.docker.com/2016/06/building-serverless-apps-with-docker/</a> 一下是正文内容。</p>

<p>处在这技术日新月异的时代里，新的技术浪潮经常对当前的技术产生着威胁和颠覆。在编写应用的时候我们目前经常谈论到“Serverless”技术。它的核心思想是把应用作为一系列的功能/function来部署，这些功能在需要的时候被按需部署。服务器管理应该是不需要去操心的事情，所有功能被按需调用，被运行在群集之上。</p>

<p>但是 Serverless 里不意味着没有 Docker，事实上 ”Docker 就是 Serverless”。你可以用 Docker 来容器化这些功能，然后按需地运行在 Swarm 群集上。Serverless 是一种构建分布式计算的应用的方法，而 Docker 是完美的构建和运行他们的平台。</p>

<h2 id="server--serverless">从Server 到 Serverless</h2>

<p>那么我们如何来编写 Serverless 的应用？让我们先看下这个例子：<a href="https://github.com/docker/example-voting-app">“一个有5个子服务组成的投票应用”</a>：</p>

<p><img src="https://media.licdn.com/mpr/mpr/shrinknp_800_800/AAEAAQAAAAAAAAlaAAAAJGI5NTZjMjRkLTRkNmYtNDEyOC04OTNiLTBmY2I5M2QyOTZiMQ.png" alt="" /></p>

<p>它的结构如下：</p>

<ul>
  <li>两个 web 前端</li>
  <li>一个后台的处理投票的 worker 服务</li>
  <li>一个处理投票的消息队列</li>
  <li> 一个数据库</li>
</ul>

<p>那个后台处理投票的进程是非常容易成为转换为 Serverless 架构的目标。在投票应用内，我们可以运行一点类似于下面的代码，来执行后台任务：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
import dockerrun

client = dockerrun.from_env()

client.run("bfirsh/serverless-record-vote-task", [voter_id, vote], detach=True)

</code></pre>
</div>

<p>Worker 和消息队列能用按需在 Swarm 上运行的容器来替换，并自动地按需扩容。</p>

<p>我们甚至可以消除掉 web 前端。我们可以这么做：用 Docker 容器来相应每一个HTTP 请求，每个 HTTP 请求都用一个自生长的跑着轻量 HTTP 服务器的容器来处理。之前使用的是长时间持续运行的 HTTP 服务器，现在变成了具有 HTTP 相应和处理能力的按需跑起来的容器，而且他们能自动地扩容来支持所有访问请求。</p>

<p>我们新的架构大概如下图所示：</p>

<p><img src="https://media.licdn.com/mpr/mpr/shrinknp_800_800/AAEAAQAAAAAAAAjOAAAAJGQyYTVhZTFiLTRkZWQtNDE0Yi1iMzRkLWU4OWU5NjExZDc2OQ.png" alt="" /></p>

<p>其中红色的方块是需持续长期运行的服务，而绿色方块成了按需被调用的 Docker容器。这样这个应用变成了只有少数几个需要被管理的 long-running 服务，在相应请求的时候使用原生的 Swarm 扩容能力，处理能力的上限是 Swarm 群集的上限。</p>

<h2 id="section">具体如何实现</h2>

<p>这里有三个有用的技巧，可以在你的程序中使用：</p>

<ol>
  <li>把你代码中的 function 作为按需拉起的 Docker 容器</li>
  <li>使用 Swarm 在群集上运行这些容器</li>
  <li>从容器里面运行这些功能容器，绕过了一个 Docker API socket</li>
</ol>

<p>使用以上技术的组合，程序执行负载发生的可能性将和您如何架构你的应用相关。运行后台任务就是一个非常适合的例子，但是整个应用中的其它工作负载也是有可能的，例如：</p>

<ul>
  <li>考虑到延迟，用启动一个容器来服务所有用户的 HTTP 请求可能是不现实的。可是你可以写一个内置的负载均衡逻辑，让它知道何时需要主动地自动扩容 Web 前端自身，通过在 Swarm 群集上运行更多 web 处理容器。</li>
  <li>一个 MongoDB 容器可以在 Swarm 上成为一个具有自省能力的架构，它能自动地运行出正确数量的 shard 和 replica 容器。</li>
</ul>

<h2 id="section-1">接下来</h2>

<p>我们已经得到了这些激进的新工具，用做构建应用的抽象层，我们隐约看到了如何深入下去的可能性。我们依然像长时间以来在一堆服务器上构建应用一样，而以后可以来利用 Swarm 能按需地在基础架构里的任何地方执行功能代码的能力。</p>

<p>希望这些能够给您一些如何构建应用的新思路，但是我们还需要你们的帮助。我们已经有的是一些构建 Serverless 应用的基础功能，然而他们依然不是很完备，我们需要更好的工具、库、样例程序，文档等等。</p>

<p><a href="https://github.com/bfirsh/serverless-docker">这个 Github 库有一些工具、库、代码和文章的链接。</a>基于此，如果您想学习更多的话，请共享任何相关的链接，这样我们可以开始协作在一起。</p>

<p>大家一起来搞，并祝 hacking 愉快！</p>


  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-06-22T10:35:39+08:00"><a href="http://martinliu.cn/2016/06/22/closing-general-session-moby-docks-cool-hacks/">June 22, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://martinliu.cn/about/" title="About Martin Liu">Martin Liu</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://martinliu.cn/2016/06/22/closing-general-session-moby-docks-cool-hacks/" rel="bookmark" title="DockerCon 2016 D2 超萌码头酷黑客 大会圆满闭幕" itemprop="url">DockerCon 2016 D2 超萌码头酷黑客 大会圆满闭幕</a></h1>
    
  </header>
  <div class="entry-content">
    <p>Closing General Session 的主题是 Moby Dock‘s Cool Hacks ； 从字面意思上看，这个主题的意思是“超萌码头酷黑客”的意思。我已经看到了关于最后一天开幕主题演讲的评论，说是“剑指商业”什么的；而我认为 Docker 从开始的第一天，无论它是否开源，它都是为了商业利益而已。话在说回到开源，Docker 只是完美的应用了开源软件这种实践而已；而且docker 把开源这种模式应用的如此成功，并在商业上也如此让人眼红和侧目，这也算是开源软件商业化登峰造极的一种极端性个案。个人认为开源无疑是在软件行业中做出爆款技术当之无愧的首选的实践方式。我在红帽碰到很多参与开源十几二十年的老黑客，他们不乏会表达关于开源纯洁性沦丧的抱怨；我对此也非常理解和认同。而我更认同开源可以对软件技术带来无比活力的这个积极的方面。</p>

<p>言归正传，小编我还是“模拟现场”播报一下大会闭幕主题演讲的盛况。这是大会的结束的 session，现场的人数明显的少于第一天开幕式的人。在十几分钟内，人们稀稀拉拉的进入了会场。会场中的座位大约还有一部分空位。美女Mano 和 黑客Kristie 作为主要演讲人上台。美女上台后先用手机自拍了几下。两个人开始宣布，Docker 大会之后举行为期一个月的黑客大赛，这是我们的传统，Docker 大会虽然今天会结束，而docer 黑客大赛将从今天开始。我们来请大家欣赏三个非常酷的黑客项目演示。</p>

<p>本次大会的录音点这里 <a href="http://www.ximalaya.com/32280565/sound/17388272">http://www.ximalaya.com/32280565/sound/17388272</a></p>

<h2 id="section">黑客演示1：微服务自毁平台</h2>

<p>Jeff 登场。Jeff 开始讲述微服务的故事，我们都在试图让基础架构做到冗余，容所有的服务都冗余，让群集能够自愈；但是故障，断网，宕机还是会发生。我们所做的这些真的能够保证业务不宕机么，服务不终端么？你怎么能确认这一点？因此回归到故障的发生上吧？如果服务要出故障，请让它有规律的发生。请程序猿和 ops 都投入到故障处理的战斗中，以此为契机来优化和改造应用，让应用变的更加强壮。我们都听说过混乱猴子，而 Jeff 团队正式帮人们构建一堆这样的工具的人。</p>

<p>有一个思路是：如何让我的系统的服务出故障，如何主动的在系统中注入故障。我们需要一种特殊的编排工具来在系统中模拟和触发故障的发生。我用容器做工具平台来触发故障注入的动作。当然这个故障是在容器架构的微服务系统中触发这个动作。</p>

<p>Jeff 开始做这个 Demo。说：如果你的”网络没有故障，天下太平。“其实这很无聊的说，有木有？有木有？我现在开始用工具来注入 网络延迟的网络故障吧！ 。用一个基于策略的工具。配置一个网络故障模拟的策略，故障什么时间发生，发生多久。这里设计一个每10秒钟注入一次网络延迟故障提高到600ms 的故障。然后配置故障影响的范围，这里使用 Docker 的 lable 来做故障发生节点的选择的条件。符合标签的系统将受到这次故障影响。我们的这个故障模拟编排系统，帮您提前体验故障的发生。现在你看故障发生了，从这些容器里面 ping google 的网络延迟比之前大多了， 目前延迟到了600ms。希望你们能开始体验和使用这个而工具。</p>

<h2 id="serverless-">黑客演示2：Serverless 架构的应用不是梦</h2>

<p>Ben 是大家在 Docker 大会喜闻乐见的一个黑客，他经常给做 demo 和 session。他绝对符合超萌的标准。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/40906-1.jpeg" alt="40906 (1)" /></p>

<p>Ben 开讲，Serverless 是如何做的？ben 认为 Serverless 是一种全新的应用编程的思路，而 docer 可以很好的支持这种思路，并实现和执行这种思路。docer 群集可以让Serverless引用按需执行，并让该应用的底层变得资源冗余并路由可达。ben 开始演示 他的几张 slides， 说 Sererless == docker这个概念。本开始讲解：如何用Serverless架构来实现投票应用的改造。如何把这个5个服务模块的纯粹容器微服务系统转换为 serverless 架构的应用。开始修改源代码，把发入队列的票，变成一个处理投票的容，把 http 服务器变成一个 CGIHander（）服务；但是 nodejs 不支持 CGIhander，肿么办？我用 perl 重写了这部分，为毛用 perl，被忘了它乃是古董级的黑客神器的好不好，呵呵！改造完之后的系统架构如下。架构是把处理 postgresql 意外的模块都重写了。数据库保留在最下层。这种Serverless重构实践遵从的原则如下。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/2-1.jpg" alt="2" /></p>

<p>三个原则翻译一下：</p>

<ol>
  <li>
    <p>把每个模块的核心功能打包，并作为容器来运行。解读：这意味着把所有服务模块组重构，把每个服务模块中的核心功能代码作为一个在容器里面跑的对象。这里其实牵扯到很深的业务重构和应用重构，程序猿或将抛弃以前的代码，甚至以前所习惯使用的程序开发堆栈。</p>
  </li>
  <li>
    <p>把这些容器用 Docker 的 Swarm 跑起来。解读：docker 原生的Swarm 编排能力将为您的应用提供，功能的运行，workload 的分布，服务的冗余，服务的路由等等支持；这样的架构能支持到 Serverless 的应用的模型。</p>
  </li>
  <li>
    <p>从容器中去运行其它容器。解读：容器编排平台或将不是容器生命起源的唯一起点，容器里面的应用可能可以决定系统中需要滋生出什么样的容器，当然说的是需要实现和运行什么功能的容器。</p>
  </li>
</ol>

<p>好了，目前为止，ben 的心的应用重构完成，还是用 docker-compose up 启动了改造之后的应用。现在看到了这个 serverless 的应用工作正常。</p>

<p>Ben 说：我们在这demo 了 serverless  应用的改造的过程，可以看到 docker 是如何支持这种应用架构的。你可以打包 web front 为服务，它自动的在 Swarm 群集上无限延展这个服务。成为分布式计算的架构。还可以打包微服务的其它应用模块为 Serverless 应用架构。欢迎大家 参与到我的 Serverless github 项目中，和我一起互动，把 Serverless 在 docker 上的应用搞起来。<a href="https://github.com/bfirsh/serverless-docker">https://github.com/bfirsh/serverless-docker</a> 这里包括了以上演示的应用。</p>

<h2 id="section-1">黑客演示3：在线更新的无人机</h2>

<p>这个团队做 in the air update 无人机实时演示。无人机其实是树莓派加他们的 docker 软件系统。这是一个嵌入式系统的设计。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/3-1.jpg" alt="3" /></p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/4.jpg" alt="4" /></p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/5.jpg" alt="5" /></p>

<p>实时新旧系统的切换秘密在这里。新版的容器会先运行起来，新系统用一个队列来接收旧系统的数据，这些数据是新旧系统交接的必要的数据，系统会判断需要多长时间，需要收集那些数据来完成这个交接的过程。直到旧系统到新系统的割接完毕。</p>

<p>程序猿开始更新 v1的代码，加入了摄像头实时视频功能。更新提交了 v2的镜像文件。在下图可以实时的监视到无人机的状态。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/6.jpg" alt="6" /></p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/1-1.jpg" alt="1" /></p>

<p>无人机在在线更新软件中。并没有掉地上哈哈哈！</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/6.1.jpg" alt="6.1" /></p>

<p>右下角是新版本软件的摄像头把大会现场的视频拍摄，并实时传递到控制台的效果。此图上面的那个图，中间凸起震荡的那个块是无人机软件升级实时更新的过程。</p>

<p>本黑科技演示完毕。</p>

<h2 id="hackathon-">hackathon 黑客大赛启动</h2>

<p>主此人再次上台启动了黑客大赛。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/7.jpg" alt="7" /></p>

<p>为期一个月的 hackathon 正式开始。</p>

<h2 id="section-2">最后看点</h2>

<p>CEO CTO 上台感谢赞助商。所罗门开始讲黑客骚扰现象。号召大家通过<a href="http://hackharassment.com"> http://hackharassment.com</a> 网站来抵制中现象。</p>

<p>Bump UP 是通过手环实现的，人们的手环彼此碰撞会在系统中增加一个点数。宣布了碰撞点数最多的前5名，感谢他们在本次大会中，积极的和其它人互动和沟通，请他们去领奖。所罗门号召所有现场的人再次相互碰撞手环，系统系统的点数增加到两百万。来解锁 Docker 奖学金基金。很快大家碰撞起来。奖学金解锁。</p>

<p>感谢进三千名的社区 贡献者，感谢 docker 的员工。所有人发来的自拍形成了一个西雅图拼图。最后大会圆满结束。</p>

<p>看到最后的才能做最后的评论。这更感觉是一个黑客大会，引入了 docker 对社会的责任感的概念。商业财富越大的人社会责任感应该更多。更像是黑客公司商业成功之后，继续创新，并开始践行自己的社会责任的大会。大会并没有结束，黑客大赛在接下来的一个月里将在全球各地延续。</p>


  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-06-21T03:30:33+08:00"><a href="http://martinliu.cn/2016/06/21/dockercon-2016-d1-keynote/">June 21, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="http://martinliu.cn/about/" title="About Martin Liu">Martin Liu</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://martinliu.cn/2016/06/21/dockercon-2016-d1-keynote/" rel="bookmark" title="DockerCon 2016 D1 Keynote" itemprop="url">DockerCon 2016 D1 Keynote</a></h1>
    
  </header>
  <div class="entry-content">
    <p>看点：开场乌龟引起了喵星人大战，首次有吉祥物开启的科技盛会。 和往常一样 CEO 和 CTO 挑大梁将首日 keynote。 所罗门提出了 Docker 技术发展的三个核心方向和着眼点，并在每个方向上做了新技术发布。 1. 开发者体验提升， 正式发布 Docker for Mac/Windws 2. 编排能力的提升，正式发布 Docker 1.12 ，其中有四项能力提升；这是要废掉所有其他编排器的节奏啊~ 3. 运维体验提升，正式发布 beta.docker.com ；这是和公有云深度结合的产品，分为 AWS 和 Azure 两个模块。 一共有三个实景演示，都没有出现问题，演示很成功。</p>

<h2 id="section">现场录音</h2>

<p>点上面的播放键，播放整场录音。请注意中间的数秒钟乃至数十秒的中断是正常，请快进收听。</p>

<h2 id="section-1">开场</h2>

<p>屏幕上出现了乌龟开始做 demo，运行了一个容器。 猫咪大战，混乱了，猫星人入侵了。猫叫~~乱作一团··· 发生了什么？ dockercon16 吹起了号角。 乌龟再次出现在电脑上，运行了另外一个容器惊喜，这次是美妙的音乐。 调皮的乌龟折腾完了之后，主题曲想起来。4000多人的场子，大家很期待。</p>

<h2 id="ceo-ben-golub-">CEO Ben Golub 演讲</h2>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/2.jpg" alt="2" /></p>

<p>Ben Golub CEO 出场。 Today we are all docker blue. 欢迎所有人。 我们和前两年的不同，我们发布了1.0 等等。 谈了很多 Docker 取得的成就。 感谢和表扬了社区。 感谢2900+贡献者。 社区的状态动态，每周超过300 PR，三分之二来自 Docker 公司之外。 docker meetup 的状况， 250+城市举行，125K 人参加聚会。 内容构建方面，docker hub 上有 460K 个应用，到目前为止有4.1B 此镜像下载。 感谢 docker 的生态社区。 讲述了这两年的使用场景的变化。Docker 逐渐成为了企业级的应用。 所有穿着红色衣服的起立，他们是 Dockr 公司的员工，感谢他们，请鼓掌。 感谢今年的赞助商。 向 Demo Gods 致敬，给神献上祭品，保证后续的演示顺利。 we pray to the old codes and the new.</p>

<h2 id="cto-">CTO 所罗门演讲</h2>

<p>所罗门出场。 我去，4000多人在场，我老爸也在家看我视频直播。 很荣欣大家来参加，感谢大家来参会。 谁参加过 DockerCon14？ 我们要开始做很多的 demo 在会议过程中。 最精彩的部分是，我们来自全球各个行业的不同层面，多样性简直是不可思议。原因是：Programming is changing the world. 我们在一起的原因是：Docker 是编程创新的助力工具。 We’re building Docker incrementally, in the open. 最好的工具目前看不是那些软件工具巨人的公司提供的，而是来自社区和群众的创新，是你们指引着我们构建了愈来愈多的工具。 社区告诉我们几个方面需要努力。</p>

<h3 id="section-2">1 开发者体验</h3>

<p>构建最好的工具，这个工具需要有这些特质：</p>

<ol>
  <li>
    <p>get out of the way;</p>
  </li>
  <li>
    <p>adopt to you；</p>
  </li>
  <li>
    <p>make the powerful simple</p>
  </li>
</ol>

<p>我们努力地践行着这些理念。 Docker for Mac/Windows 将是最无缝的开发者体验。 Making things easy is really hard. 我们在寻找最佳的系统工程师，我们收购了 Unikernel 公司。 在移动游戏行业里面找到最佳的设计者。</p>

<h3 id="docker-for-mac">第一个演示 – Docker for Mac</h3>

<p>演示者登台。 我是个开发者，今天第一天上班。 安装了 Docker for Mac 打开这个应用，启动它。 克隆 
<code class="highlighter-rouge">
git clone viting-app 
</code>
运行 
<code class="highlighter-rouge">
docker-compose up
</code>
 打开投票应用的两个web界面。 我不知道这个应用是什么，但是一个命令就启动了所有5个服务。 我发现了程序的 bug。 是否我第一天上班就能修复它？ 分析了一下程序架构图。 查看 docker-compose.yml 文件。 找到了一个 debug 显示的的那一行。 在代码中加入了 live debug 的断点。 开始 review 代码，发现了奇怪的地方。 找到了 git 上的代码，增加了评论，提出源码结果计算方法有问题。 现在删除了有问题的哪一行代码。 删除了断点。 用 live debug 的方式修复代码。 回到程序界面，发现 bug 没了。 做 git commit 提交修正后的代码。 查看了该应用在 staging 环境的情况，发现也有相同的结果计算的问题。 进入该环境的 Docker Cloud界面，看到了这个运行环境。 查看 result 服务的构建策略是自动构建。 Docker Cloud 自动接收了新的代码，Staging 环境的构建完成并通过了测试脚本，程序正常了。 查看云里的 Staging 环境的 bug 也被除掉了。demo 结束。</p>

<h3 id="splice--cto-matt-">Splice 的 CTO Matt 案例分享</h3>

<p>Splice 的 CTO Matt；我们做的是个音乐服务的技术，我们构建的服务像是给音乐人用的 github。 每天都有人上传上很多 TB 的音乐数据。 我们在 Mac 上开发，在 Linux 上部署。 我们使用多种数据存储。 Docker 让我们保持多种环境的一致，降低了 debug 的时间。 所有的程序运行在容器中。 我们一天更新线上的业务20多次。 Developer 的第一天工作就能为业务提供价值。 我们使用 Docker for Mac。</p>

<h3 id="orchestration-">2 Orchestration 编排能力</h3>

<p>我们听到很多 happy user 的故事。 感谢所有7万多 Docker for Mac beta 的反馈参与者。 我宣布 Docker for Mac/Widnwos beta 完全开放下载。 很多人告诉我们需要在 Orchestration 上更加努力。 它在 ship 方面提供支持，能发布你整个的应用，让你不再关心单个的容器。 Orchestration是个技术活，只有专家才能干。很少人能做这个工作。 可是用户怎么能即不出现手头人才短缺，又不被某些厂商在这方面给技术锁定呢？ 更好的方法是什么？ Docker 1.12 将内置编排功能。 最佳的编排技术将是 Docker 自己。</p>

<p><img src="http://cdn1.martinliu.cn/wp-content/uploads/2016/06/3.jpg" alt="3" /></p>

<p>我们先提前介绍一些它的新功能。</p>

<ul>
  <li>
    <p>Swarm mode</p>
  </li>
  <li>
    <p>Cryptographic node identity</p>
  </li>
  <li>
    <p>Docker Service API</p>
  </li>
  <li>
    <p>Build-in Routing Mesh</p>
  </li>
</ul>

<p>非常简单的演示，你就明白了。 欢迎第三个 编排的演示 Docker 1.12 技术。</p>

<h3 id="docker-swarm-">第二个演示 – docker swarm 功能演示</h3>

<p>两个人上场。 用一个新的机器，上面只安装了 docker。 有三个节点。 第一个节点上初始化群集 docker swarm init 第二个节点上加入群集 docker swarm join 在第三个节点上加入群集 docker swarm join 三节点的群集建立完成。</p>

<p>为毛它没有让输入任何安全的信息和选项，这就对了，我们有内置的 PKI 安全通讯机制。 所有节点都有自己的身份标识。密钥定期自动变化。所有通讯都可以追述到发起者的身份。</p>

<p>你们都懂 docker run 子命令。 docker service 命令是新来的子命令。 service 的定义是将要维持服务的状态。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker service create --name voting-app -p 5000 
docker service ls


</code></pre>
</div>

<p>所有的服务只启动了一个容器，分布在三个节点上。</p>

<p>看到投票应用页面显示了。</p>

<p>浏览器访问了第一个节点的 ip:5000 ，然后第二个节点的 ip:5000 端口，发现实际上访问到了第一个节点上的的容器。这就是新的容器路由的功能。所有的节点访问这个服务的端口，都可以路由到该服务的容器里。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker service scale 6
</code></pre>
</div>

<p>现在扩容服务的容器。 每次刷新页面，页面上容器的ID都在变，这是群集内置的 round robin 负载均衡策略，把访问分发到所有容器。这就是内置的负载均衡功能。</p>

<p>我们升级这个 app 吧。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker service update 


</code></pre>
</div>

<p>演示容器镜像文件的更新 选择另外一个 tag 的镜像来升级 现在我们可以对电影投票了</p>

<p>滚动升级可以支持 加上一次升级2个容器的升级选项，因此它现在是做两个一次的服务容器升级，直到所有容器都升级结束。</p>

<p>我们说的自愈功能是说，能让应用可以在机器宕机的时候，业务也不中断。 请把有两个容器的 node3 关机。 调度器现在自动在 node2上长出刚才运行在 node3上的那两个容器。保持6个容器的服务配置。</p>

<p>演示成功，并没有出问题。</p>

<h3 id="zenly-">Zenly 的创始人案例分享</h3>

<p>所罗门高兴的再次上台。 这说明我们的祭品生效了，演示没有出毛问题。 docker 1.12 在几周后就发布，Docker for Mac beta 版本上现在就有这些功能。你们这些已经安装的现在就可以尝试这些功能。 我们自由的扩容业务应用，而服务速度不受到影响。 在大规模的关键业务中的部署才是目标。我们请 Zenly 的兄弟们上台。</p>

<p>Zenly 的人喝了两杯祭品的冰咖啡上台了。 我们有1M 用户，是最近的三个月内获得的。 500M events/day 一共才 6 engineers 我们运行业务在云上。 我们现在把部分业务迁移回自己的物理机。 我们在10台物理机上运行部分业务。 部分运行在 GCE 上。 我们感觉按需扩容很爽。</p>

<h3 id="section-3">3 运维体验</h3>

<p>我们谈到开发者体验，业务编排。 群众还告诉我们“Ops experience” 运维体验是需要关注第三个侧面。 Docker 应该深度和云基础架构集成。</p>

<h4 id="betadockercom-">beta.docker.com 发布</h4>

<p>我宣布beta.docker.com 发布。包括 docker for aws 和 docker for Azure 是最原生的 AWS 和 Azure 体验。是和云基础架构最深的集成。 现在可以用 AWS CloudFormation 来部署 Swarm 群集。 可以自动配置所有的负载均衡端口等配置。</p>

<h4 id="wwwdockercomdab-">www.docker.com/dab 发布</h4>

<p>www.docker.com/dab 是新的可移植多容器应用打包格式。 这是新的 ops 体验。是让 developer 和 Ops 更容易工作在一起的方案。</p>

<h3 id="section-4">第三个演示 – 云运维体验</h3>

<p>Developer：我想赶紧回家。我还需要赶紧交货。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker compose bundle 

</code></pre>
</div>

<p>产生了一个.dab 文件，齐活了。 把应用的 .dab 文件给 Ops 即可。 Ops：你的应用是 docker的么？ 额的个神啊！ 我喜欢在 AWS 上用Docker。 看我新建Stack的 AWS 向导，这里可以配置了一个新的 docker swarm 群集。 看我这有一个已经部署了100节点的群集。 所有网络、存储、负载均衡都不用手动配置。 复制 这个网址。 在 Mac 电脑的 shell 粘贴 ，后点击回车。 我们进入了命令行 docker for aws 的特殊的 shell 我能看的所有群集和主机的状态 把你的 .dab 文件给我，就欧了~ 用 USB copy 给你。 把文件 copy 给了 Ops scp .dab 文件到 swarm 群集中。 在进入 shell ls 能看的这个文件</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker deploy  voting-app  xxx.dab 


</code></pre>
</div>

<p>看这些所有服务都运行了</p>

<div class="highlighter-rouge"><pre class="highlight"><code>docker service ls
docker service update -p 80:80  voting-app
docker service update -p 8080:8080  result-app
docker service scale 


</code></pre>
</div>

<p>扩容这些服务的容器数量 打开浏览器确认应用部署结果，找到 ELB 的配置，配置已经自动生成了。 浏览器中访问 ELB 的80端口上看的投票页面 在 ELB 的 8080 端口看的结果页面 这下应用部署完毕。 原来你的 Ops 工作怎么这么简单啊！！ I got go home ~~~</p>

<h2 id="section-5">结束</h2>

<p>所罗门感谢大家，所请访问 docker.com/getdocker 有需要的尽管说。 请在这几天内，尽量多的告诉我们，你们的需求和使用场景。 请告诉我们 what we build next ! thank you very much ！！</p>

<h2 id="section-6">注意</h2>

<p>我是 Maritn Liu 为您播报本次大会的各种信息，对以上内容有任何问题和疑问请加我微信咨询，我的微信号是 martinliu_cn ，这篇文章也会在我的微信公众号（aws-faq）和 ”刀客微播报“上发布。以上会议记录中所有命令的操作并不是准确的演示者输入，尽量参考这些命令来想想其可能的参数和语法，如果你安装了最新版本的 Docker for Mac 可以自己试一下。</p>


  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    
      
        <li><a href="http://martinliu.cn/page2/" class="btn">向前</a></li>
      
    

    
    
      <li><a href="http://martinliu.cn">1</a></li>
    

    
    

    
    
    

    
      
        
        
        
        <li><a href="http://martinliu.cn/page2/">2</a></li>
      
    
      
        <li><strong class="current-page">3</strong></li>
      
    
      
        
        
        
        <li><a href="http://martinliu.cn/page4/">4</a></li>
      
    
      
        
        
        
        <li><a href="http://martinliu.cn/page5/">5</a></li>
      
    

    
    
      <li>…</li>
    

    
      <li><a href="http://martinliu.cn/page94/">94</a></li>
    

    
    
      <li><a href="http://martinliu.cn/page4/" class="btn">下一页</a></li>
    
  </ul>
</div>



</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Martin Liu.</span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://martinliu.cn/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://martinliu.cn/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-749876-6', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


          

</body>
</html>